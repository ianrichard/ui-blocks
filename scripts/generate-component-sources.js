import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Read index.ts
const indexPath = path.resolve(__dirname, "../src/components/index.ts");
const indexSource = fs.readFileSync(indexPath, "utf-8");

// Extract all imports from index.ts
const imports = [];

// Match default imports: import MantineCard from "./Card/MantineCard";
const defaultImportRegex = /import\s+(\w+)\s+from\s+["'](.\/[^"']+)["']/g;
let match;

while ((match = defaultImportRegex.exec(indexSource)) !== null) {
  const [, importName, importPath] = match;
  imports.push({
    importName,
    importPath,
    sourceName: `${importName}Source`,
  });
}

// Match default + named imports: import Tabs, { Tab, TabPanel } from "./Tabs/Tabs";
const mixedImportRegex =
  /import\s+(\w+)\s*,\s*\{([^}]+)\}\s+from\s+["'](.\/[^"']+)["']/g;

while ((match = mixedImportRegex.exec(indexSource)) !== null) {
  const [, defaultImport, , importPath] = match;

  // Only add if not already added
  if (!imports.some((i) => i.importPath === importPath)) {
    imports.push({
      importName: defaultImport,
      importPath,
      sourceName: `${defaultImport}Source`,
    });
  }
}

// Match named imports: import { X, Y } from "./Path";
const namedImportRegex = /import\s+\{([^}]+)\}\s+from\s+["'](.\/[^"']+)["']/g;

while ((match = namedImportRegex.exec(indexSource)) !== null) {
  const [, namedList, importPath] = match;

  // Get the first named import as representative
  const firstNamed = namedList.split(",")[0].trim();
  const importName = firstNamed.split(/\s+as\s+/)[0].trim();

  // Only add if not already added
  if (!imports.some((i) => i.importPath === importPath)) {
    imports.push({
      importName,
      importPath,
      sourceName: `${importName}Source`,
    });
  }
}

// Generate the componentSources.ts file
const outputPath = path.resolve(
  __dirname,
  "../src/pages/editor/componentSources.ts"
);

const fileContent = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * Generated by scripts/generate-component-sources.js from index.ts
 * Run: npm run generate:component-sources
 */

${imports
  .map(
    ({ sourceName, importPath }) =>
      `import ${sourceName} from ".${importPath}.tsx?raw";`
  )
  .join("\n")}

export const componentSourceMap: Record<string, string> = {
${imports
  .map(({ importName, sourceName }) => `  ${importName}: ${sourceName},`)
  .join("\n")}
};
`;

fs.writeFileSync(outputPath, fileContent);
console.log("âœ… Generated componentSources.ts");
console.log("   Components:", imports.length);
console.log("   Names:", imports.map((i) => i.importName).join(", "));
